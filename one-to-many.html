<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro&display=swap');
        :root {
            --bg-chat-900: #111;
            --bg-chat-800: #222;
            --bg-chat-700: #333;
            --bg-chat-600: #444;
            --bg-chat-500: #777;
            --bg-chat-400: #bbb;
            --bg-chat-300: #ccc;
            --bg-chat-200: #ddd;
            --bg-chat-100: #eee;
            --bg-chat-50: #fff;

            --bg-green-900  : rgb(5, 133, 76);
        }
        /* @import url('https://fonts.googleapis.com/css2?family=Poppins&display=swap'); */
        * {
            box-sizing: border-box;
            padding: 0;
            margin: 0;
        }
        .messenger {
            z-index: 10000;
            background-color: #fff;
            width: calc(230px + 100px);
            height: calc(370px + 100px);
            border-radius: 1rem;
            /* font-family: 'Poppins', sans-serif; */
            bottom: 0;
            right: 0;
            position: fixed;
            margin-right: 100px;
            margin-bottom: 5px;
            box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        }
        .messenger .container {
            display: flex;
            justify-content: center;
        }
        /* .messenger__header { */
        /* .chat__box--header {
            color: #fff;
            height: 10%;
            background-color: var(--bg-green-900);
            border-radius: .8rem .8rem 0rem 0rem;
            width: 100%;
            margin-left: 0;

            display: flex;
            justify-content: flex-end;
            align-items: center;
        } */
        .header__buttons {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
        }
        #crossbar {
            font-size: 2rem;
            font-weight: lighter;
            cursor: pointer;
        }
        #minimizer, #maximizer {
            font-size: 1.5rem;
            cursor: pointer;
        }
        .messenger__body {
            width: 100%;
            margin-left: 0;
            position: relative;
            height: 75%;
            overflow-y: scroll;
            overflow-x: hidden;
            scrollbar-width: none;  /* Firefox */
        }
        /* .messenger__footer { */
        .chat__box--footer {
        /* .footer { */
            width: 100%;
            margin-left: 0;
            height: 15%;
            border-top: 1px solid rgba(0, 0, 0, 0.3);
            background-color: #fff;
            position: relative;
            /* display: flex;
            justify-content: center;
            align-items: center; */
        }
        .footer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;

            position: absolute;
            top: 25%;
            right: 2%;
        }
        .messenger textarea {
            /* font-size: 1.2rem; */
            width: 108%;
            border: none;
            resize: none;
            border-radius: 4px;
            background: none;
        }
        .messenger textarea:focus {
            /* border: none; */
            outline: none;
        }
        .messenger textarea::placeholder {
            color: var(--bg-chat-500);
        }
        /* .message {
            border-right: 2px solid rgba(0, 0, 0, 0.12);
        } */
        .message__send {
            margin-top: 20%;
            font-size: 2.5rem;
            color: var(--bg-green-900);
            background-color: #fff;
            border: none;
        }
        .message__send:hover {
            font-size: 2.6rem;
        }
        .conversation {
            margin: 10px 10px;
            position: relative;
        }
        .conversation__user {
            display: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #222;
        }
        .conversation__text {
            box-shadow: rgba(0, 0, 0, 0.12) 0px 1px 3px, rgba(0, 0, 0, 0.24) 0px 1px 2px;
            background-color: #fff;
            border-radius: 5px;
            padding: 8px;
            padding-bottom: 15px;
            width: fit-content;
            max-width: 90%;
            min-width: 30%;
            position: relative;
        }
        .receiver {
            margin-left: 20px;
        }
        .receiver-name {
            text-transform: capitalize;
            font-size: 1.8rem;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }
        /* .receiver-name.p2p {
            display: flex;
        } */
        .sender {
            margin-right: 20px;
        }
        .timestamp {
            bottom: .8px;
            right: 5px;
            font-size: 1.5rem;
            position: absolute;
            color: #777;
        }
        /* .bubble-arrow {
            position: absolute;
            width: 0;
            bottom: 40px;
            left: -16px;
            height: 0;
        }
        .bubble-arrow.alt {
            right: -2px;      
            bottom: 40px;
            left: auto;
        }
        .bubble-arrow:after {
            content: "";
            position: absolute;
            border: 0 solid transparent;
            border-top: 9px solid #fff;
            border-radius: 0 20px 0;
            width: 15px;
            height: 30px;
            transform: rotate(145deg);
        }
        .bubble-arrow.alt:after {
            transform: rotate(45deg) scaleY(-1);
        } */
        .messenger .date {
            background-color: #fff;
            box-shadow: rgba(0, 0, 0, 0.15) 1.95px 1.95px 2.6px;
            padding: 5px 8px;
            border-radius: 5px;
        }
        .divider span {
            display: inline-block;
        }
        .divider {
            text-align: center;
            z-index: 30;
            position: sticky;
            top: 10px;
        }
        @keyframes fadeOut {
            0%   {opacity: 1;}
            90%  {opacity: 1;}
            100% {opacity: 0;}
        }
        .messenger__body::-webkit-scrollbar {
            display: none;
        }
        /* Extra small devices (phones, 600px and down) */
        @media only screen and (max-width: 600px) {
            .messenger textarea {
                font-size: 1.5rem;
            }
            .conversation {
                font-size: 1.6rem;
            }
        }

        /* Small devices (portrait tablets and large phones, 600px and up) */
        @media only screen and (min-width: 600px) {
            .messenger textarea {
                font-size: 1.5rem;
            }
            .conversation {
                font-size: 1.5rem;
            }
        }

        /* Medium devices (landscape tablets, 768px and up) */
        @media only screen and (min-width: 768px) {
            .messenger textarea {
                font-size: 1.5rem;
            }
            .conversation {
                font-size: 1.5rem;
            }
        }

        /* Large devices (laptops/desktops, 992px and up) */
        @media only screen and (min-width: 992px) {
            .messenger textarea {
                font-size: 1.5rem;
            }
            .conversation {
                font-size: 1.5rem;
            }
        }

        /* Extra large devices (large laptops and desktops, 1200px and up) */
        @media only screen and (min-width: 1200px) {
            .messenger textarea {
                font-size: 1.5rem;
            }
            .conversation {
                font-size: 1.5rem;
            }
        }

        body {
            height: 100vh;
            /* font-family: 'Poppins', sans-serif; */
            font-family: 'Source Sans Pro', sans-serif;
        }
        #chat {
            position: sticky;
            border-radius: 50%;
            top: 90%;
            left: 93%;
            width: 60px;
            height: 60px;
            overflow: hidden;
            box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;    
        }
        .chat__icon {
            cursor: pointer;
            width: 100%;
            height: 100%;
            background-color:#1362b3;
            display:flex;
            justify-content:center;
            align-items:center;
        }
        .chat__box {
            position: sticky;
            top: 19.5%;
            /* top: 10vh; */
            left: 70.5%;
            width: 380px;
            height: 550px;
            /* width: 400px;
            height: 700px; */
            border-radius: 20px;
            background-color: #fff;
            overflow: hidden;
            /* box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px; */
            box-shadow: rgba(0, 0, 0, 0.09) 0px 3px 12px;
        }
        .chat__box--header {
            /* background-color: white; */
            height: 12%;
            display: flex;
            align-items: center;
            /* gap: 20px; */
            justify-content: space-between;
            padding: 0 15px;
            /* justify-content: space-around; */
            border-bottom: 1px solid #ebedef;
        }
        .buttons {
            padding-right: 10px;
            display: flex;
            gap: 8px;
            /* padding: 10px; */
            /* background-color: #1362b3; */
        }
        .buttons > div {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: #444;

            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;

            cursor: pointer;
        }
        /* .buttons > div:hover, .back-button:hover {
            background-color: #ebedef;
        } */
        .back-button {
            /* margin: 0 7px; */
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: #444;

            display: flex;
            /* align-items: center; */
            /* justify-content: center; */
            font-size: 2.2rem;
            /* display: inline-block; */
            cursor: pointer;
        }
        .name {
            /* display: inline-block; */
            /* display: flex;
            flex-direction: column; */
        }
        .center {
            display: flex;
            align-items: center;
            /* justify-content: center; */
        }
        .receiver-name {
            display: flex;
            /* justify-content: center; */
            align-items: center;
            /* font-size: 1.2rem; */
            /* padding-left: 10px; */
            color: #444;
            width: 100%;

            text-transform: capitalize;
        }
        .chat__box--body {
            height: 73%;

            overflow-y: scroll;
            overflow-x: hidden;

            word-wrap: break-word;
        }
        .chat__box--footer {
            background-color: white;
            height: 15%;
            /* padding: 20px;
            padding-left: 5px; */
        }
        #message {
            padding: 5px 12px;
            /* border: none; */
            width: 280px;
            height: 40px;
            outline: none;
            resize: none;
            border-radius: 20px;
            /* font-size: .95rem; */
            /* font-size: large; */
            /* border: 2px solid #1362b3; */
            background-color: #ebedef;
            border: none;
            color: #444;
            /* resize: none;
            white-space: nowrap;
            overflow-x: scroll; */
        }
        /* #message::-webkit-scrollbar {
            display: none;
        } */
        .attachment {
            background-color: #e7e7e7;
            /* padding: 9px; */
            border-radius: 50%;
            height: 30px;
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
        }
        .send-button{
            /* padding: 10px;
            border: .5px solid #333;
            border-radius: 20px; */
            /* background-color: #444; */
            /* color: #fff; */
            cursor: pointer;
            width: 40px;
            height: 40px;
            background-color:#ebedef;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .message {
            height: 50px;
            padding: 10px;
            margin-bottom: 10px;

            text-transform: capitalize;
        }

        .hover-div:hover {
            background-color: rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .hover-div {
            padding: 10px 10px;
            border-radius: 7px;
        }

        .hover-div > span {
            display: block;
        }

        .hover-div__receiver-name {
            font-size: 1.1rem;
        }

        .p2p {
            display: none;
        }

        .chat__box--footer.all-messages {
            height: 0;
        }

        /* .chat__box--footer.p2p {
            height: 15%;
        } */

        .chat__box--body.all-messages {
            height: 88%;
        }

        .history.message {
            /* background-color: #1362b3; */
            padding: 5px;
            margin: 5px;
            position: relative;
        }

        .history.message:hover {
            background-color: rgba(0, 0, 0, 0.03);
            cursor: pointer;
        }

        .history--receiver-name {
            font-size: 17px;
            font-weight: bold;
        }
        .history--message {
            font-size: 14px;
            font-weight: inherit;
            color: rgba(0, 0, 0, 0.7);
        }
        .unseen-message .history--message {
            color: darkgreen;
            /* color: #000; */
            /* font-weight: bold; */
            font-weight: 600;
        }
        /* .unseen-message::after {

            font-weight: bold;
            content: '';
            position: absolute;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            right: 1%;
            top: 50%;
            background-color: #444;
        }
        .unseen-message::before {

            font-weight: bold;
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            right: 1.1%;
            top: 51%;
            border: 1px solid #fff;
            border-radius: 50%;
            z-index: 1;
        } */
    </style>
</head>
<body>
    <div id="chat" onclick="maximizeChatBox()">
        <div class="chat__icon">
            <svg width="36" height="36" viewBox="0 0 36 36">
                <path fill="white" d="M1 17.99C1 8.51488 8.42339 1.5 18 1.5C27.5766 1.5 35 8.51488 35 17.99C35 27.4651 27.5766 34.48 18 34.48C16.2799 34.48 14.6296 34.2528 13.079 33.8264C12.7776 33.7435 12.4571 33.767 12.171 33.8933L8.79679 35.3828C7.91415 35.7724 6.91779 35.1446 6.88821 34.1803L6.79564 31.156C6.78425 30.7836 6.61663 30.4352 6.33893 30.1868C3.03116 27.2287 1 22.9461 1 17.99ZM12.7854 14.8897L7.79161 22.8124C7.31238 23.5727 8.24695 24.4295 8.96291 23.8862L14.327 19.8152C14.6899 19.5398 15.1913 19.5384 15.5557 19.8116L19.5276 22.7905C20.7193 23.6845 22.4204 23.3706 23.2148 22.1103L28.2085 14.1875C28.6877 13.4272 27.7531 12.5704 27.0371 13.1137L21.673 17.1847C21.3102 17.4601 20.8088 17.4616 20.4444 17.1882L16.4726 14.2094C15.2807 13.3155 13.5797 13.6293 12.7854 14.8897Z"></path>
            </svg>
        </div>
    </div>
    <div class="chat__box" style="display: none;">
        <div class="chat__box--header">
            <div class="receiver-name p2p">
                <div class="center">
                    <span class="back-button" onclick="p2pReset()">
                        <img src="./public/img/back.png" alt="" width="70%"> 
                    </span>
                    <span class="name">{{receiverName}}</span>
                </div>
            </div>
            <div class="receiver-name all-messages">
                <span>Messages</span>
            </div>
            <div class="buttons">
                <div class="minus">
                    <img src="./public/img/minus-3108.png" alt="" width="60%">
                </div>
            </div>
        </div>
        <div class="chat__box--body all-messages">
            <ul>
                <!-- <li *ngFor="let message of allMessage | async">
                    <div class="message" [ngStyle]="{'fontWeight': message.seenStatus ? 'normal' : 'bold'}">
                        <div class="hover-div" onclick="p2p(message)">
                            <span class="hover-div__receiver-name">{{message.receiverName}}</span>
                            <span class="hover-div__receiver-message" [ngStyle]="{'fontSize': '.8rem'}">{{message.msg.length > 45 ? message.msg.slice(0, 45) + '...' : message.msg}}</span>
                        </div>
                    </div>
                </li> -->
            </ul>
        </div>
        <div class="chat__box--body p2p">

        </div>
        <div class="chat__box--footer all-messages">
        </div>
        <div class="chat__box--footer p2p">
            <div class="footer">
                <div class="attachment">
                    <svg viewBox="0 0 24 24" height="20px" width="20px" class="b6ax4al1 m4pnbp5e aqweqrfb ahndzqod db0glzta tnag3kze"><g fill-rule="evenodd"><polygon fill="none" points="-6,30 30,30 30,-6 -6,-6 "></polygon><path d="m18,11l-5,0l0,-5c0,-0.552 -0.448,-1 -1,-1c-0.5525,0 -1,0.448 -1,1l0,5l-5,0c-0.5525,0 -1,0.448 -1,1c0,0.552 0.4475,1 1,1l5,0l0,5c0,0.552 0.4475,1 1,1c0.552,0 1,-0.448 1,-1l0,-5l5,0c0.552,0 1,-0.448 1,-1c0,-0.552 -0.448,-1 -1,-1m-6,13c-6.6275,0 -12,-5.3725 -12,-12c0,-6.6275 5.3725,-12 12,-12c6.627,0 12,5.3725 12,12c0,6.6275 -5.373,12 -12,12"></path></g></svg>
                </div>
                <div class="textarea">
                    <input type="text" id="message">
                </div>
                <div class="send-button" onclick="sendMessage2()">
                    <svg width="20px" height="20px" viewBox="0 0 24 24" class="db0glzta"><path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 C22.8132856,11.0605983 22.3423792,10.4322088 21.714504,10.118014 L4.13399899,1.16346272 C3.34915502,0.9 2.40734225,1.00636533 1.77946707,1.4776575 C0.994623095,2.10604706 0.8376543,3.0486314 1.15159189,3.99121575 L3.03521743,10.4322088 C3.03521743,10.5893061 3.34915502,10.7464035 3.50612381,10.7464035 L16.6915026,11.5318905 C16.6915026,11.5318905 17.1624089,11.5318905 17.1624089,12.0031827 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z"></path></svg>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <!-- firebase.js -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
        import { connectFirestoreEmulator, getFirestore, collection, doc, getDocs, setDoc, onSnapshot, query, Timestamp, orderBy, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-firestore.js";
        import { initializeAppCheck, getToken } from "https://cdnjs.cloudflare.com/ajax/libs/firebase/9.9.2/firebase-app-check.min.js";

        export class Message {
            constructor(id, message, date, profile, type, url) {
                this.date = date 
                this.id = id
                this.message = message
                this.profile = profile
                this.type = type
                this.url = url
            }
            toString() {
                return this.id + `(profile: ${this.profile})` + ' sent ' + this.message + `(type: ${this.type})` + ' at ' + this.date;
            }
        }
        const messageConverter = {
            toFirestore: (content) => {
                return {
                    id: content.id,
                    date: content.date,
                    message: content.message,
                    profile: content.profile,
                    type: content.type,
                    url: content.url
                };
            },
            fromFirestore: (snapshot, options) => {
                const data = snapshot.data(options);
                return new Message(data.id, data.message, data.date, data.profile, data.type, data.url);
            }
        }

        class History {
            constructor(receiverName, senderName, msg, seenStatus, datetime) {
                this.receiverName = receiverName 
                this.senderName = senderName
                this.msg = msg
                this.seenStatus = seenStatus
                this.datetime = datetime
            }
            toString() {
                return this.id + `(profile: ${this.profile})` + ' sent ' + this.message + `(type: ${this.type})` + ' at ' + this.date;
            }
        }
        const historyConverter = {
            toFirestore: (content) => {
                return {
                    receiverName: content.receiverName,
                    senderName: content.senderName,
                    msg: content.msg,
                    seenStatus: content.seenStatus,
                    datetime: content.datetime
                };
            },
            fromFirestore: (snapshot, options) => {
                const data = snapshot.data(options);
                return new History(data.receiverName, data.senderName, data.msg, data.seenStatus, data.datetime);
            }
        }

        class Firestore {
            #firebaseConfig = {
                apiKey: "AIzaSyCXpbTwk85O8WdHnMDy6BlQYY_8hZhi8xI",
                authDomain: "dt-chat-382db.firebaseapp.com",
                databaseURL: "https://dt-chat-382db-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "dt-chat-382db",
                storageBucket: "dt-chat-382db.appspot.com",
                messagingSenderId: "335861675650",
                appId: "1:335861675650:web:0e7699c3d9be6015e4a69b"
            };
            constructor() {
                this.app = initializeApp(this.#firebaseConfig);
                this.db = getFirestore(this.app);

                this.room = `/chat/dt-guest/room/p2p/`
                this.history = `/chat/dt-guest/history`

                // this.appCheck();
                // this.setupEmulator();
                
                this.unsubscribeListener = null;
                this.unsubscribeListenerHistory = null;

                // this.subscribe();
            }

            set p2pCollectionDoc(room) {
                this.collection = collection(this.db, this.room + room);
                this.doc = doc(this.collection);
            }

            set merchantCollection(user) {
                const newHistory = this.history + `/merchant/${user.id}`;
                this.merchantHistoryCollection = collection(this.db, newHistory)
            }

            set merchantDoc(chat) {
                this.merchantHistoryDoc = doc(this.db, this.history + `/merchant/${chat.user1.id}`, chat.user2.id)
            }

            set clientCollection(user) {
                this.clientHistoryCollection = collection(this.db, this.history + `/client/${user.id}`)
            }

            set clientDoc(chat) {
                this.clientHistoryDoc = doc(this.db, this.history + `/client/${chat.user2.id}`, chat.user1.id)
            }

            appCheck() {
                const appCheck = initializeAppCheck(
                    this.app, { provider: ReCaptchaV3Provider } // ReCaptchaV3Provider or CustomProvider
                );
            }
            setupEmulator() {
                connectFirestoreEmulator(this.db, 'localhost', 8080);
            }
        }

        class HistoryFirestore extends Firestore {
            constructor() {
                super();
            }
            subscribe() {
                const recentMessagesQuery = query(this.merchantHistoryCollection, orderBy("datetime", "asc"));
                const histories = [];
                this.unsubscribeListenerHistory = onSnapshot(recentMessagesQuery.withConverter(historyConverter), function(snapshot) {
                    snapshot.docChanges().forEach(function(change) {
                        var history = change.doc.data();
                        if (change.type === "added") {
                            // console.log("New city: ", change.doc.data());
                            // displayHistory(history);
                            displayHistory(history);
                            histories.push(history)
                        }
                        if (change.type === "modified") {
                            const newItem = change.doc.data();
                            const previousMessage = histories.filter(item => item.receiverName == newItem.receiverName);
                            if (previousMessage && previousMessage.length && previousMessage[0].seenStatus !== newItem.seenStatus && previousMessage[0].msg == newItem.msg) {
                                clearUnseenMessageStyle(newItem);
                            } else {
                                removePreviousHistory(newItem);
                                displayHistory(history);
                            }
                            histories.splice(histories.indexOf(previousMessage), 1);
                            histories.push(history)
                            // updateHistoryView(change, change.doc.data());
                            // if (change.oldIndex == 0 || change.oldIndex !== change.newIndex) {
                            //     removePreviousHistory(change.doc.data());
                            //     displayHistory(history);
                            // } else {
                            //     clearUnseenMessageStyle(change.doc.data());
                            // }
                            // displayHistory(history);
                            // console.log("Modified city: ", change.doc.data());
                        }
                        // if (change.type === "removed") {
                        //     console.log("Removed city: ", change.doc.data());
                        // }
                        // console.log(change.doc._document.readTime.timestamp.seconds)
                        // if (!change.doc.metadata.hasPendingWrites) {
                        // displayMessage(message);
                        // displayHistory(history);
                        // new Chat().display(message)
                        // chat.display(message);
                        // }
                    });
                }, function(err) {
                    // chat.permissionDenialModal(err.code.toUpperCase());
                    // console.log(err)
                });
            }
            unsubscribe() {
                try {
                    // this.unsubscribeListener();
                    this.unsubscribeListenerHistory = null;
                } catch(err) {
                    // console.log(err);
                }
            }
        }

        class P2PFirestore extends Firestore {
            constructor() {
                super();
            }
            async storeMessage(data) {
                try {
                    const ref = this.doc.withConverter(messageConverter);
                    const merchantHistoryRef = this.merchantHistoryDoc.withConverter(historyConverter)
                    const clientHistoryRef = this.clientHistoryDoc.withConverter(historyConverter)

                    await addDoc(this.collection, messageConverter.toFirestore(data));
                    await setDoc(merchantHistoryRef, new History(this.user1.id, this.user2.id, data.message, 0, data.date), {merge: true})
                    await setDoc(clientHistoryRef, new History(this.user2.id, this.user1.id, data.message, 1, data.date), {merge: true})
                } catch(err) {
                    // console.log(err)
                    throw err;
                }
            }
            async setSeenStatusTrue() {
                // const clientHistoryRef = this.clientHistoryDoc.withConverter(historyConverter)
                const merchantHistoryRef = this.merchantHistoryDoc.withConverter(historyConverter);
                // await updateDoc(clientHistoryRef, {"seenStatus": 0})
                await updateDoc(merchantHistoryRef, {"seenStatus": 0})
                // await setDoc(clientHistoryRef, new History(this.user2.id, this.user1.id, data.message, 0, data.date), {merge: true})
                // clientHistoryRef.update({"seenStatus": 0});
            }
            async readAll() {
                const querySnapshot = await getDocs(this.collection);
                querySnapshot.forEach((doc) => {
                    // console.log(doc.id, " => ", doc.data());
                });
            }
            subscribe() {
                const chat = this.chat;
                const recentMessagesQuery = query(this.collection, orderBy("date", "asc"));
                this.unsubscribeListener = onSnapshot(recentMessagesQuery.withConverter(messageConverter), function(snapshot) {
                    snapshot.docChanges().forEach(function(change) {
                        var message = change.doc.data();
                        // console.log(message)
                        // console.log(message.toString(), new Date(message.date.seconds*1000));
                        // console.log(change.doc._document.readTime.timestamp.seconds)
                        // if (!change.doc.metadata.hasPendingWrites) {
                        displayMessage(message);
                        // new Chat().display(message)
                        // chat.display(message);
                        // }
                    });
                }, function(err) {
                    chat.permissionDenialModal(err.code.toUpperCase());
                    // console.log(err)
                });
            }
            unsubscribe() {
                try {
                    // this.unsubscribeListener();
                    this.unsubscribeListener = null;
                } catch(err) {
                    console.log(err);
                }
            }
        }
        window.HistoryFirestore = HistoryFirestore;
        window.P2PFirestore = P2PFirestore;
        window.Message = Message;
    </script>
    <!-- all-messages -->
    <script type="module">
        let historyChat;
        class ChatHistory {
            constructor(user) {
                this.history = new HistoryFirestore();
                this.history.merchantCollection = user;
                this.history.subscribe();
            }
        }

        window.displayHistory = (history) => {
            const body = $(".chat__box--body.all-messages");
            const room = {
                clientName: history.receiverName == "pet shop bd" ? history.senderName : history.receiverName,
                merchantName: history.receiverName == "pet shop bd" ? history.receiverName : history.senderName
            };
            body.prepend(`
                <div class="history message" onclick=p2pChat('${encodeURIComponent(JSON.stringify(room))}')>
                    <div class="${history.seenStatus == 0 ? '' : 'unseen-message'}">
                        <div class="history--receiver-name">
                            ${history.receiverName == "pet shop bd" ? history.senderName : history.receiverName}
                        </div>
                        <div class="history--message">
                            ${history.msg.substr(0, 30)}
                        </div>
                    </div>
                </div>
            `);
        }

        window.removePreviousHistory = (history) => {
            const body = $(".chat__box--body.all-messages");
            const candidateNode = $(".history .history--receiver-name:contains('"+ history.receiverName +"')").parent().parent();
            // candidateNode.fadeOut();
            candidateNode.hide();
        }

        window.clearUnseenMessageStyle = (history) => {
            const body = $(".chat__box--body.all-messages");
            const candidateNode = $(".history .history--receiver-name:contains('"+ history.receiverName +"')").parent();
            // const candidateNode = $(".history .history--receiver-name:contains('"+ history.receiverName +"')").siblings("history--message").first();
            // candidateNode.fadeOut();
            candidateNode.removeClass("unseen-message");
        }

        window.updateHistoryView = (change, document) => {
            const body = $(".chat__box--body.all-messages");
            const candidateNode = $(".history .history--receiver-name:contains('"+ history.receiverName +"')").parent();
        }

        window.LoadHistory = (user) => new Promise((resolve, reject) => {
            if (historyChat) {
                resolve(historyChat);
                return;
            }
            historyChat = new ChatHistory(user);
            resolve(historyChat);
        })
    </script>
    <!-- p2p -->
    <script type="module">
        const p2p = new P2PFirestore();
        const messageDates = new Map();
        let newDate = null, dateChanged = null, firstDateSlot = true;
        let chatRoom = null;
        const p2pChat = (room) => {
            window.state = "p2pChat"
            room = JSON.parse(decodeURIComponent(room))
            p2p.user1 = { id: room.merchantName, type: "receiver", name: room.merchantRoom };
            p2p.user2 = { id: room.clientName, type: "sender" };
            chatRoom = room;
            p2p.p2pCollectionDoc = `${room.merchantName}-${room.clientName}`;
            p2p.merchantCollection = p2p.user1;
            p2p.merchantDoc = { user1: p2p.user1, user2: p2p.user2 };
            p2p.clientCollection = p2p.user2;
            p2p.clientDoc = { user1: p2p.user1, user2: p2p.user2 };
            $(".receiver-name.p2p span:last-child").text( room.clientName );
            p2p.subscribe();
            p2p.setSeenStatusTrue();
        }
        window.sendMessage = (message) => {
            const content = new Message(p2p.user1.id, message, new Date(), "", 'msg', window.location.href);
            p2p.storeMessage(content)
        }
        function display(content) {
            try {
                if (window.state == "history") return
                $(".all-messages").attr('style', 'display: none !important')
                const messengerBody = $('.chat__box--body.p2p');
                $(".p2p").attr('style', 'display: block !important');
                // const sentBy = this.user1.type == "sender" ? "sender" : "receiver";
                const sentBy = p2p.user1.id == content.id ? "sender" : "receiver";
                const timestamp = new Date(content.date) == "Invalid Date"
                                ? new Date(content.date.seconds*1000) : new Date(content.date);
                const [day, month, year, hour, minute] = 
                    [timestamp.getDay(), timestamp.getMonth(), timestamp.getFullYear(), timestamp.getHours(), timestamp.getMinutes()];

                // console.log(timestamp.toLocaleDateString("en-Bn"), day, month, year)

                // const today = new Date();
                // const date = today.getDay() == day && today.getMonth() == month && today.getFullYear() == year 
                //             ? "Today" : (day + '/' + month + '/' + year);
                const date = timestamp.toLocaleDateString("en-Bn");
                dateChanged = messageDates.get(date);
                const sentAt = hour > 12 
                    ? `${(hour - 12).toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')} pm` 
                    : `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')} am`;

                // messengerBody.append(`<div>${content.message}</div>`);
                if (!dateChanged) {
                    newDate = newTimestamp(date);
                    messengerBody.append(bindNewMessage(sentBy, content.message, newDate, sentAt));
                    messageDates.set(date, true);
                } else {
                    newDate.append(
                        bindNewMessage(sentBy, content.message, null, sentAt)
                    )
                    messengerBody.append(newDate)
                }
                messengerBody.animate({ scrollTop: messengerBody[0].scrollHeight + 1000 }, 50);
            } catch(err) {
                throw err;
            }
        }
        function newTimestamp(timestamp) {
            const date = $(`<div class="conversation__date"></div>`);
            firstDateSlot = false;
            const divider = !firstDateSlot 
                ? $(`<div class="divider"><span class="date"> ${timestamp} </span></div>`)
                : $(`<div class="divider"><span class="date" id="divider__top" style="opacity: 0;"> ${timestamp} </span></div>`)
            firstDateSlot = false;
            date.append(divider);
            return date;
        }
        function bindNewMessage(sentBy, message, timestamp = null, sentAt = null) {
            const sender = `<div class="row conversation sender">
                <!-- <div class="col-lg-3 conversation__user">
                </div> -->
                <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9 pull-right conversation__text">
                    <span> ${message} </span> 
                    <span class="timestamp">${sentAt}</span>
                </div>
                <div class="bubble-arrow alt"></div>
            </div>`;
            const receiver = `<div class="row conversation receiver">
                <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9 conversation__text">
                    <span>${message}</span> 
                    <span class="timestamp">${sentAt}</span>
                </div>
                <div class="bubble-arrow"></div>
                <!-- <div class="col-lg-3 conversation__user">
                </div> -->
            </div>`;
            if (timestamp) {
                timestamp.append(sentBy == 'receiver' ? receiver : sender)
                return timestamp;
            } else {
                return $(sentBy == 'receiver' ? receiver : sender);
            }
        }
        function invalidUsers(user1, user2) {
            return (!user1.id) || (!user2.id);
        }

        window.displayMessage = display;
        window.p2pChat = p2pChat;
    </script>
    <script>
        function maximizeChatBox() {
            const courierName = "pet shop bd"
            const merchant = { id: courierName, type: "receiver", name: courierName };
            try {
                window
                    .LoadHistory(merchant)
                    .then(history => { /* console.log(history)*/ })
                    .catch(err => { /* console.log(err) */ })
            } catch(err) {
                // console.log(err);
            }
        }

        function p2pReset() {
            window.state = "history"
            $(".p2p").attr('style', 'display: none !important')
            $(".all-messages").attr('style', 'display: block !important')
            $(".chat__box--body.p2p").empty();

            const found = [];
            const allMessages = $(".history.message")
            // console.log(Object.keys( allMessages ))
            // allMessages.forEach(node => {
            for (let node = 0; node < allMessages.length; ++node) {
                // if (found.indexOf(node))
                // console.log($(allMessages[node]).fadeOut())
                const el = $(allMessages[node]);
                const candidate = el.children().children(".history--receiver-name")
                const clientName = candidate.text().trim();
                if (found.includes(clientName)) {
                    // candidate.parent().parent().empty();
                    candidate.parent().parent().detach()
                    // console.log(candidate.text().trim());
                }
                found.push(clientName);
            }
            // })
        }

        jQuery(function($) {
            const messengerBody = $('.chat__box--body');
            const chatBox = $('#message');
            const crossBar = $('#crossbar');
            const minimizer = $('.minus');
            const maximizer = $(".chat__icon");
            const messageSendButton = $(".send-button");
            const messengerHeader = $(".chat__box--header");
            const chatButton = $(".btn");
            const messenger = $(".chat__box");

            messengerBody.scroll(function() {
                let currentLabel = null;
                const topLabel = $("#divider__top");
                $(".divider").each(function(_, el) {
                    if (messengerBody.scrollTop() >= $(el).offset().top) {
                        currentLabel = el;
                    }
                });
                if (currentLabel) {
                    $(topLabel).css({"opacity": 1});
                    topLabel.textContent = $.trim(currentLabel.textContent)
                } else {
                    $(topLabel).css("opacity", 0);
                }
            });
            minimizer.click(function() {
                messenger.attr('style', 'display: none !important')
                // minimizer.attr('style', 'display: none !important')
                // maximizer.attr('style', 'display: block !important')
            });

            maximizer.click(function() {
                // messenger.css({"bottom": "0px"});
                // maximizer.attr('style', 'display: none !important')
                // minimizer.attr('style', 'display: block !important')
                messenger.attr('style', 'display: block !important')
            })
            messageSendButton.click(async function() {
                try {
                    const text = chatBox.val();
                    if (!text) {
                        // console.log("empty message")
                        return;
                    }
                    chatBox.val('');
                    // await chat.send(text);
                    window.sendMessage(text);
                    notPermitted = false;
                    messengerBody.animate({ scrollTop: messengerBody[0].scrollHeight + 1000 }, 50);
                } catch(err) {
                    notPermitted = true;
                    // console.log(err)
                    // chat.permissionDenialModal(err.code.toUpperCase());
                }
            });
            chatButton.click(function() {
                try {
                    messenger.attr('style', 'display: block !important');
                    maximizer.attr('style', 'display: none !important')
                    minimizer.attr('style', 'display: block !important')
                    messenger.css({"bottom": "0px"});
                    messengerBody.animate({ scrollTop: $('.messenger__body')[0].scrollHeight + 1000 }, 5);
                } catch(err) {
                    // chat.permissionDenialModal(err.code.toUpperCase());
                }
            })
        });
        function sendMessage2() {}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</body>
</html>